# Azure Pipeline for RideOn Backend (npm workspaces)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - apps/backend/**
      - package.json
      - package-lock.json

# üîê Attach Variable Group HERE (top-level)
variables:
- group: rideon-backend-prod

pool:
  vmImage: ubuntu-latest

steps:
  # Install Node.js (use LTS for stability)
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'
    displayName: 'Install Node.js'

  # Install dependencies for npm workspaces (ROOT ONLY)
  - script: |
      npm ci
    displayName: 'Install dependencies (npm workspaces)'

  # Optional: Lint backend
  - script: |
      npm run lint --workspace=apps/backend || echo "Lint skipped"
    displayName: 'Lint backend'

  # Dummy build (plain Node.js)
  - script: |
      npm run build --workspace=apps/backend
    displayName: 'Build backend'

  # Run backend tests
  - script: |
      npm test --workspace=apps/backend
    displayName: 'Test backend'
    env:
      NODE_ENV: test
      DB_HOST: $(DB_HOST)
      DB_PORT: $(DB_PORT)
      DB_USER: $(DB_USER)
      DB_PASSWORD: $(DB_PASSWORD)
      DB_NAME: $(DB_NAME)
      JWT_SECRET: $(JWT_SECRET)
      DATABASE_URL: $(DATABASE_URL)
      CORS_ORIGIN: $(CORS_ORIGIN)
